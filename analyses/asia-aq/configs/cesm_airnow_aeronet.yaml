# ASIA-AQ CESM/CAM-chem Evaluation Configuration
# Comparing model output with AirNow surface observations, AERONET AOD, and Pandora NO2 columns
#
# Model: CESM/CAM-chem (f.e3b06m.FCnudged.t6s.01x01.01)
# Period: February 1-29, 2024 (leap year)
# Domain: 0-45°N, 90-140°E

analysis:
  start_time: "2024-02-01"
  end_time: "2024-02-29"
  output_dir: output
  debug: false

  # City labels for spatial plots: {name: [lat, lon]}
  city_labels:
    Beijing: [39.9, 116.4]
    Seoul: [37.5, 127.0]
    Tokyo: [35.7, 139.7]
    Shanghai: [31.2, 121.5]
    Manila: [14.6, 121.0]
    Bangkok: [13.75, 100.5]
    Hanoi: [21.0, 105.85]
    Singapore: [1.35, 103.8]
    Kuala Lumpur: [3.15, 101.7]
    Hong Kong: [22.3, 114.2]

# Model configuration
model:
  cesm_asiaq:
    mod_type: cesm_fv
    files: /Users/fillmore/Data/ASIA-AQ/CAM/f.e3b06m.FCnudged.t6s.01x01.01.cam.h2i.2024-02-*.nc
    radius_of_influence: 15000  # 15 km for 0.1 deg grid

    # Variable mapping: obs_label -> {model_var: obs_var}
    mapping:
      airnow:
        pm25: PM25
        ozone: O3
        no2: NO2
        co: CO
      aeronet:
        aod_500nm: AODVISdn

    # Model variable configurations with unit conversions
    variables:
      O3:
        unit_scale: 1.0e9  # mol/mol to ppb
        units: ppb
        ylabel_plot: "O3 (ppb)"
        vmin_plot: 0
        vmax_plot: 100
        vdiff_plot: 30
      NO2:
        unit_scale: 1.0e9  # mol/mol to ppb
        units: ppb
        ylabel_plot: "NO2 (ppb)"
        vmin_plot: 0
        vmax_plot: 50
        vdiff_plot: 20
      CO:
        unit_scale: 1.0e9  # mol/mol to ppb
        units: ppb
        ylabel_plot: "CO (ppb)"
        vmin_plot: 0
        vmax_plot: 1000
        vdiff_plot: 200
      PM25:
        unit_scale: 1.2e9  # kg/kg to ug/m3 (× air density × 1e9)
        units: μg/m³
        ylabel_plot: "PM2.5 (μg/m³)"
        vmin_plot: 0
        vmax_plot: 150
        vdiff_plot: 50
      AODVISdn:
        unit_scale: 1.0
        units: "1"
        ylabel_plot: "AOD (550 nm)"
        vmin_plot: 0
        vmax_plot: 2.0
        vdiff_plot: 0.5

  # Precomputed NO2 column (from run_evaluation.py preprocessing)
  cesm_no2_column:
    mod_type: generic
    files: /Users/fillmore/EarthSystem/DAVINCI-MONET/analyses/asia-aq/data/cesm_no2_column_20240201_20240229.nc
    radius_of_influence: 15000
    mapping:
      pandora:
        no2_trop_column: NO2_column
    variables:
      NO2_column:
        unit_scale: 1.0
        units: mol/m²
        ylabel_plot: "NO2 Column (mol/m²)"
        vmin_plot: 0
        vmax_plot: 5.0e-4
        vdiff_plot: 2.0e-4

# Observation configurations
obs:
  airnow:
    obs_type: pt_sfc
    filename: data/airnow_asiaq_2024-02-01_2024-02-29.nc
    variables:
      pm25:
        obs_min: 0
        obs_max: 500
        units: μg/m³
        ylabel_plot: "PM2.5 (μg/m³)"
      ozone:
        obs_min: 0
        obs_max: 200
        units: ppb
        ylabel_plot: "O3 (ppb)"
      no2:
        obs_min: 0
        obs_max: 100
        units: ppb
        ylabel_plot: "NO2 (ppb)"
      co:
        unit_scale: 1000  # ppm to ppb
        obs_min: 0
        obs_max: 5000
        units: ppb
        ylabel_plot: "CO (ppb)"

  aeronet:
    obs_type: pt_sfc
    filename: data/AERONET_L15_20240201_20240229.nc
    variables:
      aod_500nm:
        obs_min: 0
        obs_max: 5.0
        units: "1"
        ylabel_plot: "AOD (500 nm)"

  pandora:
    obs_type: pt_sfc
    filename: data/pandora_no2_column_20240201_20240229.nc
    variables:
      no2_trop_column:
        obs_min: 0
        obs_max: 5.0e-3  # mol/m2
        units: mol/m²
        ylabel_plot: "NO2 Column (mol/m²)"

# Pairing groups (which model-obs combinations to analyze)
pairs:
  cesm_airnow_pm25:
    model: cesm_asiaq
    obs: airnow
    variable:
      model_var: PM25
      obs_var: pm25

  cesm_airnow_o3:
    model: cesm_asiaq
    obs: airnow
    variable:
      model_var: O3
      obs_var: ozone

  cesm_airnow_no2:
    model: cesm_asiaq
    obs: airnow
    variable:
      model_var: NO2
      obs_var: no2

  cesm_airnow_co:
    model: cesm_asiaq
    obs: airnow
    variable:
      model_var: CO
      obs_var: co

  cesm_aeronet_aod:
    model: cesm_asiaq
    obs: aeronet
    variable:
      model_var: AODVISdn
      obs_var: aod_500nm

  cesm_pandora_no2_column:
    model: cesm_no2_column
    obs: pandora
    variable:
      model_var: NO2_column
      obs_var: no2_trop_column

# Plotting configuration
plots:
  # PM2.5 plots
  pm25_timeseries:
    type: timeseries
    pairs: [cesm_airnow_pm25]
    title: "PM2.5 Time Series - ASIA-AQ (Mean ± Std)"
    show_uncertainty: true
    aggregate_dim: site

  pm25_scatter:
    type: scatter
    pairs: [cesm_airnow_pm25]
    title: "PM2.5 Model vs Observations"

  pm25_spatial_bias:
    type: spatial_bias
    pairs: [cesm_airnow_pm25]
    title: "PM2.5 Spatial Bias"

  # Ozone plots
  o3_timeseries:
    type: timeseries
    pairs: [cesm_airnow_o3]
    title: "O3 Time Series - ASIA-AQ (Mean ± Std)"
    show_uncertainty: true
    aggregate_dim: site

  o3_scatter:
    type: scatter
    pairs: [cesm_airnow_o3]
    title: "O3 Model vs Observations"

  # NO2 plots
  no2_timeseries:
    type: timeseries
    pairs: [cesm_airnow_no2]
    title: "NO2 Time Series - ASIA-AQ (Mean ± Std)"
    show_uncertainty: true
    aggregate_dim: site

  no2_scatter:
    type: scatter
    pairs: [cesm_airnow_no2]
    title: "NO2 Model vs Observations"

  no2_spatial_bias:
    type: spatial_bias
    pairs: [cesm_airnow_no2]
    title: "NO2 Spatial Bias"

  # CO plots
  co_timeseries:
    type: timeseries
    pairs: [cesm_airnow_co]
    title: "CO Time Series - ASIA-AQ (Mean ± Std)"
    show_uncertainty: true
    aggregate_dim: site

  co_scatter:
    type: scatter
    pairs: [cesm_airnow_co]
    title: "CO Model vs Observations"

  co_spatial_bias:
    type: spatial_bias
    pairs: [cesm_airnow_co]
    title: "CO Spatial Bias"

  # AOD plots
  aod_timeseries:
    type: timeseries
    pairs: [cesm_aeronet_aod]
    title: "AOD Time Series - ASIA-AQ (Mean ± Std)"
    show_uncertainty: true
    aggregate_dim: site

  aod_scatter:
    type: scatter
    pairs: [cesm_aeronet_aod]
    title: "AOD Model vs AERONET"

  aod_spatial_bias:
    type: spatial_bias
    pairs: [cesm_aeronet_aod]
    title: "AOD Spatial Bias"

  # NO2 Column plots (Pandora)
  no2_column_site_timeseries:
    type: site_timeseries
    pairs: [cesm_pandora_no2_column]
    title: "NO2 Tropospheric Column: Pandora vs CESM"
    ncols: 3
    min_points: 50
    scale_factor: 10000  # mol/m2 -> 10^-4 mol/m2

  no2_column_scatter:
    type: scatter
    pairs: [cesm_pandora_no2_column]
    title: "NO2 Column: Model vs Pandora"

  no2_column_spatial_bias:
    type: spatial_bias
    pairs: [cesm_pandora_no2_column]
    title: "NO2 Column Spatial Bias"

# Statistics configuration
stats:
  output_table: true
  output_table_kwargs:
    precision: 3
  metrics:
    - N         # Number of pairs
    - MO        # Mean observation
    - MP        # Mean prediction
    - MB        # Mean bias
    - RMSE      # Root mean square error
    - R         # Correlation coefficient
    - NMB       # Normalized mean bias (%)
    - NME       # Normalized mean error (%)
    - IOA       # Index of agreement
